{% extends "base.html" %}
{% block title %}Versions â€“ {{ story }}{% endblock %}
{% block content %}
<h1 class="text-xl font-bold mb-4">Versions for {{ story }}</h1>
{% if versions %}
  <table class="min-w-full border">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-2 border">Version</th>
        <th class="px-4 py-2 border">Author</th>
        <th class="px-4 py-2 border">Timestamp</th>
        <th class="px-4 py-2 border">Similarity</th>
        <th class="px-4 py-2 border">Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for v in versions %}
      <tr class="border-t">
        <td class="px-4 py-2">{{ v.version_number }}</td>
        <td class="px-4 py-2">{{ v.author }}</td>
        <td class="px-4 py-2">{{ v.timestamp }}</td>
        <td class="px-4 py-2">{{ (v.similarity * 100)|round(0) }}%</td>
        <td class="px-4 py-2 space-x-2">
          <form method="post" action="/run/{{ v.id }}" style="display:inline">
            <button type="submit" class="text-sm text-green-700 hover:underline">Run</button>
          </form>
          {% if not loop.first %}
          <a href="/compare/{{ versions[loop.index0 - 1].id }}/{{ v.id }}" class="text-sm text-blue-700 hover:underline">Compare to previous</a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <!-- Bar chart showing number of test cases per version -->
  <div class="mt-6">
    <h2 class="text-lg font-semibold mb-2">Test Cases per Version</h2>
    <canvas id="casesChart" height="120"></canvas>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('casesChart').getContext('2d');
    const data = {
      labels: {{ versions|map(attribute='version_number')|list }},
      datasets: [{
        label: 'Test Cases',
        backgroundColor: 'rgba(59, 130, 246, 0.7)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 1,
        data: {{ counts }}
      }]
    };
    new Chart(ctx, {
      type: 'bar',
      data: data,
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  </script>
{% else %}
  <p>No versions found for '{{ story }}'.</p>
{% endif %}
{% endblock %}